// Components, functions, plugins
import { Component, ChangeDetectionStrategy, ChangeDetectorRef, NgModule } from '@angular/core';
import { IonicPage, NavController, NavParams, LoadingController, AlertController } from 'ionic-angular';
import { Storage } from '@ionic/storage';
import { Http } from '@angular/http';
import 'rxjs/add/operator/map';
import { Database } from './../../providers/database/database';
import { Localstorage } from './../../providers/localstorage/localstorage';

declare var dateFormat: any;

@IonicPage()
@Component({
  selector: 'page-congressionaldetails',
  templateUrl: 'congressionaldetails.html',
  changeDetection: ChangeDetectionStrategy.OnPush
})

export class CongressionalDetailsPage {

	public CommitteeListing: any[] = [];
	public visualImageURL: string;
	public visualDisplayName: string;
	public visualChamber: string;
	public visualParty: string;
	public visualState: string;
	public visualDistrict: string;
	public visualBiography: string;
	public BioDetails: string;
	public WebsiteShow: boolean;
	public visWebsite: string;

	// Bookmark button
	public visBookmarkAddRemoveButton: string;
	public btnBookmarkManagement = false;
	public BookmarkButtonColor: string = '#ffffff';
	public BookmarkButtonTextColor: string = '#f53d3d';

	constructor(public navCtrl: NavController, 
				public navParams: NavParams,
				private storage: Storage,
				private databaseprovider: Database,
				private cd: ChangeDetectorRef,
				public loadingCtrl: LoadingController,
				public alertCtrl: AlertController,
				private localstorage: Localstorage) {
	}

	ionViewDidLoad() {
		console.log('ionViewDidLoad SpeakersPage');
	}

    navToWebsite(WebsiteURL) {

        if (WebsiteURL === undefined) {
            // Do nothing
        } else {
            // Initiate web browser
            if ((WebsiteURL.substring(0, 7) != "http://") && (WebsiteURL.substring(0, 8) != "https://")) {
                WebsiteURL = "http://" + WebsiteURL;
            }
			
			console.log('Congressional Details: Navigating to: ' + WebsiteURL);
            window.open(WebsiteURL, '_system');
        }

    };

	ngOnInit() {

		// Load initial data set here
		//let loading = this.loadingCtrl.create({
		//	spinner: 'crescent',
		//	content: 'Please wait...'
		//});

		//loading.present();

		// Blank and show loading info
		this.CommitteeListing = [];
		this.cd.markForCheck();
		
		// Temporary use variables
		var flags = "dt|Alpha|0|0|" + this.navParams.get('cmID');
        var DisplayName = "";
        var BioDisplay = "";
		var AttendeeID = this.localstorage.getLocalValue('AttendeeID');
		
		// Get the data
		this.databaseprovider.getCongressionalData(flags, AttendeeID).then(data => {
			
			console.log("getCongressionalData: " + JSON.stringify(data));

			if (data['length']>0) {
				
				DisplayName = "";

				// Concatenate fields to build displayable name
				//if (data[0].Prefix != "") {
				//    DisplayName = DisplayName + data[0].Prefix + " ";
				//}
				DisplayName = DisplayName + data[0].FirstName;
				if (data[0].MiddleInitial != "") {
				    DisplayName = DisplayName + " " + data[0].MiddleInitial;
				}
				DisplayName = DisplayName + " " + data[0].LastName;
				if (data[0].Suffix != "") {
				    DisplayName = DisplayName + " " + data[0].Suffix;
				}
				
				this.visualChamber = data[0].Chamber;
				this.visualParty = data[0].Party;
				
				this.visualState = data[0].StateFullname;
				if (data[0].District != "" && data[0].District != null) {
					this.visualDistrict = "District " + data[0].District;
				}

				if (data[0].Website != "" && data[0].Website != null) {
					this.visWebsite = data[0].Website;
					this.WebsiteShow = true;
				} else {
					this.WebsiteShow = false;
				}
				
				// Thumbnail
				var imageURL = "assets/img/CongressionalMembers/" + data[0].imageFilename;
				this.visualImageURL = imageURL;
				console.log("ImageURL: " + imageURL);

				this.visualDisplayName = DisplayName;

				// Biography
				if ((data[0].Bio == "") || (data[0].Bio == "&nbsp;") || (data[0].Bio == "TBD")) {
					this.BioDetails = "No biography provided";
				} else {
					BioDisplay = data[0].Bio;
					BioDisplay = BioDisplay.replace(/&nbsp;/g,' ');
					BioDisplay = BioDisplay.replace(/\r/g, '');
					BioDisplay = BioDisplay.replace(/\n/g, '');
					BioDisplay = BioDisplay.replace(/\t/g, '');
					BioDisplay = BioDisplay.replace(/<div>/g, '');
					BioDisplay = BioDisplay.replace(/<\/div>/g, '');
					BioDisplay = BioDisplay.replace(/â€™/g, "'");
					BioDisplay = BioDisplay.replace(/â€œ/g, '"');
					BioDisplay = BioDisplay.replace(/Â/g, ' ');
					BioDisplay = BioDisplay.replace(/â€/g, '"');
					this.BioDetails = BioDisplay;
				}

				// Get session records
				flags = "cl|Alpha|0|0|" + this.navParams.get('cmID');
				
				// Get the list of courses relevant to this speaker
				this.databaseprovider.getCongressionalData(flags, "0").then(data2 => {
					
					console.log("getCongressionalData: " + JSON.stringify(data));

					if (data2['length']>0) {
						
						for (var i = 0; i < data2['length']; i++) {

							this.CommitteeListing.push({
                                DisplayCommitteeName: data2[i].CommitteeName,
                            });

						}


					} else {
						
						// No records to show
						this.CommitteeListing.push({
                            DisplayCommitteeName: "Not a member of any committees",
						});

					}

					this.cd.markForCheck();
					
				}).catch(function () {
					console.log("Promise Rejected");
				});
					

			} else {
				
                // No data to show
                this.visualDisplayName = "Unable to retrieve record";
                this.visualParty = "";
                this.visualState = "";

			}

			this.cd.markForCheck();

			//loading.dismiss();
			
		}).catch(function () {
			console.log("Promise Rejected");
		});
		
	}

}
